name: Publish Rust Crates to crates.io

on:
  push:
    tags:
      - 'rs-v*'

permissions:
  contents: read
  id-token: write

jobs:
  verify-version:
    name: Verify version matches tag
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Verify version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/rs-v}"
          CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | cut -d'"' -f2)
          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "Tag version ($TAG_VERSION) doesn't match Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi
          echo "Version $TAG_VERSION verified"

  publish-core:
    name: Publish rusty-ssim-core
    needs: verify-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@v1
        id: auth
      
      - name: Publish rusty-ssim-core
        run: cargo publish -p rusty-ssim-core
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

  publish-rustyssim:
    name: Publish rustyssim
    needs: publish-core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@v1
        id: auth
      
      - name: Publish rustyssim
        run: cargo publish -p rustyssim
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
